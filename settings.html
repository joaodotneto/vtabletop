<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="stylesheet" href="css/bootstrap.min.css?1" />
    <link rel="stylesheet" href="css/common.css?1" />
    <script type="text/javascript" src="js/jquery.min.js?1"></script>
    <script type="text/javascript" src="js/bootstrap.min.js?1"></script>
    <script type="text/javascript" src="js/common.js?3"></script>
    <script type="text/javascript" src="js/classes.js?3"></script>
    <title></title>
    <script type="text/javascript">
        $(document).ready(() => {
            $("input[type=number]").blur(function () {
                var self = $(this);
                val = parseFloat(self.val());
                min = parseFloat(self.attr("min"));
                max = parseFloat(self.attr("max"));
                if (val > max) {
                    self.val(max);
                } else if (val < min) {
                    self.val(min);
                }
            });
            CreateToggle("chkShowGrid", "divShowGrid", true, "GetSettingsAndSend()", "Hide Grid", "Show Grid");
            CreateToggle("chkShowCoords", "divShowCoords", false, "GetSettingsAndSend()", "Hide Coordinates", "Show Coordinates");
            CreateToggle("chkParallaxAnim", "divParallaxAnim", true, "GetSettingsAndSend()", "Par. Not Animated", "Par. Animated");
            CreateToggle("chkShowAllLayer", "divShowAllLayer", true, "GetSettingsAndSend()", "Hide All Layers", "Show All Layers");
            CreateToggle("chkShowMapRevealNames", "divShowMapRevealNames", false, "GetSettingsAndSend()", "Hide Rev. Names", "Show Rev. Names");
            CreateToggle("chkShowAllMapReveal", "divShowAllMapReveal", true, "GetSettingsAndSend()", "Hide All Rev.", "Show All Rev.");

            window.addEventListener("message", (event) => {
                var objParameters = event.data;
                setTimeout(() => {
                    var attrs = objParameters.attrs;
                    var cmd = objParameters.cmd;
                    switch (cmd) {
                        case "LoadSettings":
                            SetLocalSettings(attrs[0]);
                            break;
                    }
                }, 100);
                return true;
            }, false);
        });

        function SetLayer(idx, chkLayer, chkOverlay) {
            SendToParent("UpdateLayer", [idx, chkVal(chkLayer), chkVal(chkOverlay)]);
        }

        function SetAnimation(idx, chk) {
            SendToParent("SetAnimation", [idx, chkVal(chk)]);
        }

        function RunAnimation(idx) {
            SendToParent("RunAnimation", [idx]);
        }

        function SetReveal(idx, chk) {
            SendToParent("UpdateReveal", [idx, chkVal(chk)]);
        }

        function RevealLayer(idx) {
            $(`#chkShowLayer${idx}`).prop("checked", true);
            SendToParent("RevealLayer", [idx]);
        }

        function SetLocalSettings(objInp) {
            $("#numGlobalShow").val(objInp.Fog ?? 0.0);
            $("#chkShowGrid").prop("checked", objInp.G);
            $("#chkShowCoords").prop("checked", (objInp.Coords ?? false));
            if (objInp.Parallax) {
                var objP = objInp.Parallax;
                $("#chkParallaxAnim").prop("checked", objP.Anim);
            }

            if (objInp.Layers) {
                var tbHtml = ``;
                objInp.Layers.forEach((obj, idx) => {
                    tbHtml += `<tr>
                        <td style="padding-left: 5px;font-weight: bold">${obj.name}</td>
                        <td style="text-align: center;"><input type="checkbox" ${(obj.visible ? "checked" : "")}
                            id="chkShowLayer${idx}" onclick="SetLayer('${idx}', 'chkShowLayer${idx}', 'chkShowOVerlay${idx}')" /></td>
                        <td style="text-align: center;"><input type="checkbox" ${(obj.showOverlay ? "checked" : "")}
                            id="chkShowOVerlay${idx}" onclick="SetLayer('${idx}', 'chkShowLayer${idx}', 'chkShowOVerlay${idx}')" /></td>
                        <td style="text-align: center;"><input type="button" class="btn btn-success btn-sm" value="Reveal"
                            id="btnRevealLayer${idx}" onclick="RevealLayer('${idx}')" /></td>
                    </tr>`;
                });
                $("#tbLayers").html(tbHtml);
            }

            if (objInp.Reveals) {
                var tbHtml = ``;
                objInp.Reveals.forEach((obj, idx) => {
                    tbHtml += `<tr>
                        <td style="padding-left: 5px;font-weight: bold">${obj.name}</td>
                        <td style="text-align: center;"><input type="checkbox" ${(obj.visible ? "checked" : "")}
                            id="chkReveal${idx}" onclick="SetReveal('${idx}', 'chkReveal${idx}')" /></td>
                    </tr>`;
                });
                $("#tbReveals").html(tbHtml);
            }

            if (objInp.AnimInstances) {
                var tbHtml = ``;
                objInp.AnimInstances.forEach((obj, idx) => {
                    tbHtml += `<tr>
                        <td style="padding-left: 5px;font-weight: bold">${obj.name}</td>
                        <td style="text-align: center;"><input type="checkbox" ${(obj.visible ? "checked" : "")} ${(obj.runOnce ? "disabled" : "")}
                            id="chkAnimation${idx}" name="chkAnimation" onclick="SetAnimation('${idx}', 'chkAnimation${idx}')" /></td>
                        <td style="text-align: center;"><input type="button" class="btn btn-success btn-sm ${(obj.runOnce ? "" : "disabled")}" value="Run"
                            id="btnRunAnimation${idx}" onclick="RunAnimation('${idx}')" /></td>
                    </tr>`;
                });
                $("#tbAnimations").html(tbHtml);
            }
        }

        function GetSettingsData() {
            return {
                G: chkVal("chkShowGrid"),
                Coords: chkVal("chkShowCoords"),
                ShowLayers: chkVal("chkShowAllLayer"),
                ShowRevNames: chkVal("chkShowMapRevealNames"),
                ShowReveals: chkVal("chkShowAllMapReveal"),
                Parallax: {
                    Anim: chkVal("chkParallaxAnim")
                }
            };
        }

        function GetSettingsAndSend() {
            var objData = GetSettingsData();
            SendToParent("UpdateInfo", [objData]);
        }

        function SendToParent(command, attributes) {
            var objSend = {
                cmd: command,
                attrs: attributes
            };
            window.opener.postMessage(objSend);
        }

        var currInterval = null;
        var currCmdShow = false;
        var startShowVal = 0.0;
        function ExecuteShowMap(show) {
            var stsVal = getFloat("numGlobalShow");
            var timVal = getFloat("numGlobalShowStep");
            currCmdShow = show;
            startShowVal = stsVal;
            currInterval = setInterval(() => {
                startShowVal = currCmdShow ? Math.max(0, startShowVal - 0.1) : Math.min(1, startShowVal + 0.1);
                console.log(startShowVal);
                $("#numGlobalShow").val(startShowVal);
                SendToParent("ChangeFog", [startShowVal]);
                var indFinish = currCmdShow ? 0 : 1;
                if (startShowVal == indFinish) {
                    clearInterval(currInterval);
                }
            }, timVal * 100);
        }

        function SendChangeFog() {
            var stsVal = getFloat("numGlobalShow");
            SendToParent("ChangeFog", [stsVal]);
        }

        function ReloadSettings() {
            SendToParent("ReloadSettings", []);
        }

        function ReadSettings() {
            if (HasOpenFilePicker()) {
                OpenJsonFile((result) => {
                    SendToParent("OpenFile", [result]);
                });
                return;
            }
            alert("Open File Unavailable");
        }

        function CheckAllAnimations(check) {
            var isCheck = check.checked;
            $('[name="chkAnimation"]').prop("checked", isCheck).trigger("click");
        }
    </script>
    <style type="text/css">
        .reveal-panel {
            width: 100%;
            height: calc(100vh - 55px);
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div>

        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation"><a onclick="ReloadSettings()">Reload</a></li>
            <li role="presentation" class="active"><a href="#tab001" aria-controls="tab001" role="tab" data-toggle="tab">Settings</a></li>
            <li role="presentation"><a href="#tab002" aria-controls="tab002" role="tab" data-toggle="tab">Layers</a></li>
            <li role="presentation"><a href="#tab003" aria-controls="tab003" role="tab" data-toggle="tab">Map Reveals</a></li>
            <li role="presentation"><a href="#tab004" aria-controls="tab004" role="tab" data-toggle="tab">Animations</a></li>
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="tab001" style="padding: 8px">
                <table style="width: 100%;">
                    <tr>
                        <td style="width: 50px;vertical-align: top">
                            <div class="input-group input-group-sm">
                                <div class="input-group-btn">
                                    <a class="btn btn-default" onclick="ReadSettings()" title="Load Settings">
                                        <i class="glyphicon glyphicon-open"></i>&nbsp;Open
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td style="width: 8px">&nbsp;</td>
                        <td>
                            <div class="input-group input-group-sm" title="Global Show" style="margin-bottom: 3px">
                                <span class="input-group-addon" style="font-weight: bold">Fog:</span>
                                <div class="form-control input-sm">
                                    <input type="range" min="0" max="1" step="0.1" id="numGlobalShow" value="0" oninput="SendChangeFog()" />
                                </div>
                                <div class="input-group-btn">
                                    <a class="btn btn-default" onclick="ExecuteShowMap(true)" title="Show Map">
                                        <i class="glyphicon glyphicon-triangle-left"></i>
                                    </a>
                                    <a class="btn btn-default" onclick="ExecuteShowMap(false)" title="Hide Map">
                                        <i class="glyphicon glyphicon-triangle-right"></i>
                                    </a>
                                </div>
                                <span class="input-group-addon" style="font-weight: bold">Amt:</span>
                                <input type="number" class="form-control input-sm" min="0" max="3" step="0.01" id="numGlobalShowStep" value="0.5" />
                            </div>
                        </td>
                    </tr>
                </table>
                <table style="width: 100%">
                    <tr>
                        <td style="width: 175px">
                            <div id="divShowGrid"></div>
                        </td>
                        <td style="width: 175px">
                            <div id="divShowCoords"></div>
                        </td>
                        <td>
                            <div id="divParallaxAnim"></div>
                        </td>
                    </tr>
                    <tr>
                        <td><div id="divShowAllLayer"></div></td>
                        <td><div id="divShowMapRevealNames"></div></td>
                        <td><div id="divShowAllMapReveal"></div></td>
                    </tr>
                </table>
            </div>
            <div role="tabpanel" class="tab-pane" id="tab002">
                <div class="reveal-panel">
                    <table style="width: calc(100% - 10px);margin: 5px 0 0  5px" border="1">
                        <thead>
                            <tr>
                                <th style="padding-left: 5px">Layer</th>
                                <th style="width: 65px; text-align: center">Show</th>
                                <th style="width: 65px;text-align: center">Overlay</th>
                                <th style="width: 65px;text-align: center"></th>
                            </tr>
                        </thead>
                        <tbody id="tbLayers"></tbody>
                    </table>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="tab003">
                <div class="reveal-panel">
                    <table style="width: calc(100% - 10px);margin: 5px 0 0  5px" border="1">
                        <thead>
                            <tr>
                                <th style="padding-left: 5px">Reveal</th>
                                <th style="width: 65px; text-align: center">Show</th>
                            </tr>
                        </thead>
                        <tbody id="tbReveals"></tbody>
                    </table>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="tab004">
                <div class="reveal-panel">
                    <table style="width: calc(100% - 10px);margin: 5px 0 0  5px" border="1">
                        <thead>
                            <tr>
                                <th style="padding-left: 5px">Animation</th>
                                <th style="width: 65px; text-align: center">
                                    <label style="margin-bottom: 0 !important;">
                                        <input type="checkbox" style="margin-top: 0px;" onclick="CheckAllAnimations(this)" />&nbsp;<span>Show</span>
                                    </label>
                                </th>
                                <th style="width: 65px; text-align: center"></th>
                            </tr>
                        </thead>
                        <tbody id="tbAnimations"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>