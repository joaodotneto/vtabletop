<html>
<head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="stylesheet" href="css/bootstrap.min.css?1" />
    <link rel="stylesheet" href="css/common.css?5" />
    <script type="text/javascript" src="js/jquery.min.js?1"></script>
    <script type="text/javascript" src="js/bootstrap.min.js?1"></script>
    <script type="text/javascript" src="js/common.js?4"></script>
    <style type="text/css">
        @media screen and (min-width: 1300px) {
            .app-title {
                display: block;
            }
        }

        .layer-panel {
            width: 315px;
        }

        body {
            background-color: #ddd;
            margin: 0;
            padding: 0;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(() => {
            ConfigureCanvas();
        });

        function ResetCanvas() {
            canvasObj.width = window.innerWidth;
            canvasObj.height = window.innerHeight;

            canvasCtx.fillRect(0, 0, canvasObj.width, canvasObj.height);

            var cmpX = getInt("numCompX");
            var cmpY = getInt("numCompY");
            var rott = chkVal("chkHorizontal");
            var grid = chkVal("chkShowGrid");
            var cord = chkVal("chkShowCoords");
            AMMOUNT = getInt("numBox");

            if (rott) {
                var centerX = (currentImg.width) / 2;
                var centerY = (currentImg.height) / 2;
                canvasCtx.translate(centerX, centerY);
                canvasCtx.rotate((90 * Math.PI) / 180);
                canvasCtx.translate(-centerX, -centerY);
            }

            //Configurações do Parallax
            showAnimation = chkVal("chkParallaxAnim");
            parallaxDirection = chkVal("chkParallaxRtl");
            parallaxVertical = chkVal("chkParallaxVertical");
            parallaxSpeed = getFloat("numkParallaxSpeed");
            parallaxX = getInt("numParallaxX");
            parallaxY = getInt("numParallaxY");

            DrawScroll();

            canvasCtx.drawImage(currentImg, currentX + cmpX, currentY + cmpY,
                currentImg.width * cameraZoom,
                currentImg.height * cameraZoom);

            /*
            Fog of War
            // Create gradient, from middle to borders
            var size = AMMOUNT * 6;
            var gradient = canvasCtx.createRadialGradient(150, 150, 0, 150, 150, 150);
            // Opaque white in the middle
            gradient.addColorStop(0, 'rgba(255,255,255,0)');
            // Transparent white at the borders
            gradient.addColorStop(1, 'rgba(255,255,255,1)');

            canvasCtx.globalCompositeOperation = 'destination-out';
            canvasCtx.fillStyle = gradient;
            canvasCtx.fillRect(0, 0, size, size);
            */

            if (currentDarken > 0) {
                canvasCtx.fillStyle = `rgba(0, 0, 0, ${currentDarken})`;
                canvasCtx.fillRect(0, 0, canvasObj.width, canvasObj.height);
            }

            layers.forEach((layer) => {
                layer.draw();
            });

            if (rott) {
                canvasCtx.setTransform(1, 0, 0, 1, 0, 0);
            }

            var stepsV = (window.innerWidth / AMMOUNT) + 1;
            var stepsH = (window.innerHeight / AMMOUNT) + 1;

            if (grid) {
                for (var i = 0; i < stepsV; i++) {
                    if (i > 0) {
                        var pos = (i * AMMOUNT) - 1;
                        DrawVerLine(pos);
                    }
                }
                for (var j = 0; j < stepsH; j++) {
                    if (j > 0) {
                        var pos = (j * AMMOUNT) - 1;
                        DrawHorLine(pos);
                    }
                }
            }
            if (cord) DrawCoordsFull(stepsV, stepsH);
            /*
            var cc = hexToRgb($("#numColor").val());
            canvasCtx.fillStyle = `rgba(${cc.r}, ${cc.g}, ${cc.b}, 0.5)`;
            canvasCtx.fillRect((lastMouseX * AMMOUNT), (lastMouseY * AMMOUNT), AMMOUNT, AMMOUNT);
            */
        }

        function ExecuteCommand(cmd) {
            var rott = $("#chkHorizontal").prop("checked");
            switch (cmd) {
                case 0: //BX+
                    AddValueToField("#numBox", 1, parseInt);
                    ResetCanvas();
                    break;
                case 1: //BX-
                    AddValueToField("#numBox", -1, parseInt);
                    ResetCanvas();
                    break;
                case 2: //ZM+
                    AddValueToField("#numCompZ", 0.01, parseFloat);
                    SetCanvasZoom();
                    break;
                case 3: //ZM-
                    AddValueToField("#numCompZ", -0.01, parseFloat);
                    SetCanvasZoom();
                    break;
                case 4: //CX+
                    AddValueToField("#numCompX", 1, parseInt);
                    ResetCanvas();
                    break;
                case 5: //CX-
                    AddValueToField("#numCompX", -1, parseInt);
                    ResetCanvas();
                    break;
                case 6: //CY+
                    AddValueToField("#numCompY", 1, parseInt);
                    ResetCanvas();
                    break;
                case 7: //CY-
                    AddValueToField("#numCompY", -1, parseInt);
                    ResetCanvas();
                    break;

                case 8: //Up
                    ExecuteMove(Keys.Up, false, rott);
                    ResetCanvas();
                    break;
                case 9: //Down
                    ExecuteMove(Keys.Down, false, rott);
                    ResetCanvas();
                    break;
                case 10: //Left
                    ExecuteMove(Keys.Left, false, rott);
                    ResetCanvas();
                    break;
                case 11: //Right
                    ExecuteMove(Keys.Right, false, rott);
                    ResetCanvas();
                    break;

                case 12: //Configure Objects
                    ShowHideObjectPanel(false);
                    break;

                case 13: //Layers
                    ShowHideLayerPanel(false);
                    break;

                default:
                    alert("Not Implemented Yet.");
                    break;
            }
        }

        function RefreshLayerList(keepSelection = true) {
            var lstLayers = $("#lstLayers")[0];
            var currentSelection = lstLayers.selectedIndex;
            lstLayers.length = 0;
            layers.forEach((obj) => {
                AddListItem(lstLayers, obj.name, obj.index);
            });
            if (keepSelection) {
                lstLayers.selectedIndex = currentSelection;
            } else {
                lstLayers.selectedIndex = lstLayers.length - 1;
            }
        }

        var currentLayerEdit = null;
        function AddLayer() {
            LoadImage((file) => {
                var newLayer = new ImageLayer();
                newLayer.initialize(URL.createObjectURL(file), () => {
                    newLayer.name = file.name;
                    newLayer.index = $("#lstLayers").prop("length");
                    layers.push(newLayer);
                    RefreshLayerList(false);
                    EditLayer(newLayer);
                    ResetCanvas();
                });
            });
        }

        function EditLayer(layer) {
            currentLayerEdit = layer;
            $("#txtLayerName").val(layer.name);
            $("#numLayerX").val(layer.x);
            $("#numLayerY").val(layer.y);
            $("#numLayerW").val(layer.w);
            $("#numLayerH").val(layer.h);
            $("#numLayerOp").val(layer.transp);
            $("#chkShowLayer").prop("checked", layer.visible);
            $("#numLayerRot").val("0");
        }

        function GetSelectedLayer() {
            var lstLayers = $("#lstLayers")[0];
            var currentSelection = lstLayers.selectedIndex;
            return layers[currentSelection];
        }

        function CloneLayer() {
            var layer = GetSelectedLayer();
            if (!layer) return;
            var clone = confirm("Really want to clone this layer?");
            if (!clone) return;

        }

        function DeleteLayer() {
            var layer = GetSelectedLayer();
            if (!layer) return;
            var del = confirm("Really want to delete this layer?");
            if (!del) return;

        }

        function MoverLayerUp() {

        }

        function MoverLayerDown() {

        }

        function UpdateSelectedLayer() {
            if (currentLayerEdit != null) {
                currentLayerEdit.name = $("#txtLayerName").val();
                currentLayerEdit.x = getInt("numLayerX");
                currentLayerEdit.y = getInt("numLayerY");
                currentLayerEdit.w = getInt("numLayerW");
                currentLayerEdit.h = getInt("numLayerH");
                currentLayerEdit.transp = getFloat("numLayerOp");
                currentLayerEdit.visible = chkVal("chkShowLayer");
                requestAnimationFrame(ResetCanvas);
            }
        }
    </script>
</head>
<body>
    <div>
        <div style="display: none">
            <input type="file" id="uploadFile" accept="image/*" />
            <input type="file" id="uploadSettings" accept=".json" />
            <canvas id="saveCanvas"></canvas>
        </div>
        <table style="width: calc(100% - 10px); margin-top: 4px; ">
            <tr>
                <td>
                    <div class="app-title">Deploy Games Simple Virtual TableTop</div>
                </td>
                <td style="width: 8px">&nbsp;</td>
                <td style="width: 258px">
                    <div class="input-group input-group-sm">
                        <div class="input-group-btn">
                            <a class="btn btn-default" onclick="LoadBackground()" title="Background">
                                <i class="glyphicon glyphicon-picture"></i>&nbsp;Background
                            </a>
                            <a class="btn btn-default" onclick="LoadParallax()" title="Parallax">
                                <i class="glyphicon glyphicon-picture"></i>&nbsp;Parallax
                            </a>
                            <a class="btn btn-default" onclick="WriteSettings()" title="Save Settings">
                                <i class="glyphicon glyphicon-save"></i>&nbsp;Save
                            </a>
                            <a class="btn btn-default" onclick="ReadSettings()" title="Load Settings">
                                <i class="glyphicon glyphicon-open"></i>&nbsp;Open
                            </a>
                            <a class="btn btn-default" onclick="ResetAdjusts()" title="Reset">
                                <i class="glyphicon glyphicon-refresh"></i>&nbsp;Reset
                            </a>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="right-bar">
        <div class="btn-group btn-group-vertical">
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(8)">
                <i class="glyphicon glyp-adj glyphicon-arrow-up"></i>
            </a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(9)">
                <i class="glyphicon glyp-adj glyphicon-arrow-down"></i>
            </a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(10)">
                <i class="glyphicon glyp-adj glyphicon-arrow-left"></i>
            </a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(11)">
                <i class="glyphicon glyp-adj glyphicon-arrow-right"></i>
            </a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(0)">BX+</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(1)">BX-</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(2)">ZM+</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(3)">ZM-</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(4)">CX+</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(5)">CX-</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(6)">CY+</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(7)">CY-</a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(12)" title="Settings">
                <i class="glyphicon glyp-adj glyphicon-cog"></i>
            </a>
            <a class="btn btn-default btnl-lg" onclick="ExecuteCommand(13)" title="Layers">
                <i class="glyphicon glyp-adj glyphicon-list-alt"></i>
            </a>
        </div>

    </div>

    <div class="object-panel layer-panel" id="layersPanel" style="display: none">
        <table style="width: 100%;">
            <tr>
                <td><label class="lbl-header">Layers</label></td>
            </tr>
            <tr>
                <td style="text-align: right">
                    <div class="input-group input-group-sm">
                        <div class="input-group-btn">
                            <a class="btn btn-default" onclick="AddLayer()" title="Add Layer">
                                <i class="glyphicon glyphicon-plus-sign"></i>&nbsp;Add
                            </a>
                            <a class="btn btn-default" onclick="CloneLayer()" title="Clone Layer">
                                <i class="glyphicon glyphicon-copy"></i>&nbsp;Clone
                            </a>
                            <a class="btn btn-default" onclick="DeleteLayer()" title="Delete Layer">
                                <i class="glyphicon glyphicon-remove"></i>&nbsp;Rem
                            </a>
                            <a class="btn btn-default" onclick="MoverLayerUp()" title="Move Up">
                                <i class="glyphicon glyphicon-triangle-top"></i>&nbsp;Up
                            </a>
                            <a class="btn btn-default" onclick="MoverLayerDown()" title="Move Down">
                                <i class="glyphicon glyphicon-triangle-bottom"></i>&nbsp;Dwn
                            </a>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <select multiple id="lstLayers" class="form-control input-sm"></select>
                </td>
            </tr>
            <tr>
                <td>
                    <table style="width: 100%;">
                        <tr>
                            <td colspan="3">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Name:</span>
                                    <input type="text" class="form-control input-sm" id="txtLayerName" onblur="UpdateSelectedLayer()" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 50%">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">X:</span>
                                    <input type="number" class="form-control input-sm" min="0" step="1" id="numLayerX" value="0" onblur="UpdateSelectedLayer()" />
                                </div>
                            </td>
                            <td style="width: 8px">&nbsp;</td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Y:</span>
                                    <input type="number" class="form-control input-sm" min="0" step="1" id="numLayerY" value="0" onblur="UpdateSelectedLayer()" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 50%">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Width:</span>
                                    <input type="number" class="form-control input-sm" min="0" step="1" id="numLayerW" value="0" onblur="UpdateSelectedLayer()" />
                                </div>
                            </td>
                            <td style="width: 8px">&nbsp;</td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Height:</span>
                                    <input type="number" class="form-control input-sm" min="0" step="1" id="numLayerH" value="0" onblur="UpdateSelectedLayer()" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 50%">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Opacity:</span>
                                    <input type="number" class="form-control input-sm" min="0.01" max="1" step=".01" id="numLayerOp" value="1" onblur="UpdateSelectedLayer()" pattern="^\d*(\.\d{0,2})?$" />
                                </div>
                            </td>
                            <td style="width: 8px">&nbsp;</td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-addon addon-74p" style="font-weight: bold">Rotation:</span>
                                    <input type="number" class="form-control input-sm" disabled="disabled" min="0.01" max="2" step=".01" id="numLayerRot" value="0" onchange="UpdateSelectedLayer()" pattern="^\d*(\.\d{0,2})?$" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <div class="form-group form-group-sm" style="margin: 5px 0 5px 3px;">
                                    <label for="chkShowLayer" class="rem-select" title="Show/Hide Layer">
                                        <input type="checkbox" id="chkShowLayer" checked="checked" onclick="UpdateSelectedLayer()">&nbsp;Show Layer
                                    </label><br />
                                </div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <div class="object-panel" id="objectPanel" style="display: none">
        <table style="width: 100%;">
            <tr>
                <td><label class="lbl-header">Settings</label></td>
            </tr>
            <tr>
                <td>
                    <div class="form-group form-group-sm" style="margin-left: 3px; margin-bottom: 5px;">
                        <label for="chkShowGrid" class="rem-select" title="Show/Hide Grid">
                            <input type="checkbox" id="chkShowGrid" checked="checked" onclick="ResetCanvas()">&nbsp;Show Grid
                        </label><br />
                        <label for="chkHorizontal" class="rem-select" title="Rotate Map">
                            <input type="checkbox" id="chkHorizontal" onclick="ResetCanvas()">&nbsp;Rotate Background
                        </label><br />
                        <label for="chkShowCoords" class="rem-select" title="Show/hide Coordinates">
                            <input type="checkbox" id="chkShowCoords" onclick="ResetCanvas()">&nbsp;Show Coordinates
                        </label>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">Box:</span>
                        <input type="number" class="form-control input-sm" min="48" max="128" step="1" id="numBox" value="96" onblur="ResetCanvas()" />
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
                            <ul class="dropdown-menu" style="min-width: 50px !important;">
                                <li><a onclick="SetBoxValue('48')">48</a></li>
                                <li><a onclick="SetBoxValue('72')">72</a></li>
                                <li><a onclick="SetBoxValue('96')">96</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">Zoom:</span>
                        <input type="number" class="form-control input-sm" min="0.01" max="2" step=".01" id="numCompZ" value="1" onchange="SetCanvasZoom()" pattern="^\d*(\.\d{0,2})?$" />
                    </div>
                    <div class="input-group input-group-sm" title="Background Complement X">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">CX:</span>
                        <input type="number" class="form-control input-sm" min="-100" max="100" id="numCompX" value="0" onblur="ResetCanvas()" />
                    </div>
                    <div class="input-group input-group-sm" title="Background Complement Y">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">CY:</span>
                        <input type="number" class="form-control input-sm" min="-100" max="100" id="numCompY" value="0" onblur="ResetCanvas()" />
                    </div>
                    <div class="input-group input-group-sm" title="Grid Color">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">GC:</span>
                        <input type="color" class="form-control input-sm" id="numColor" value="#ff0000" oninput="ResetCanvas()" />
                    </div>
                </td>
            </tr>
            <tr>
                <td><label class="lbl-header" style="margin-top: 10px;">Parallax Settings</label></td>
            </tr>
            <tr>
                <td>
                    <div class="form-group form-group-sm" style="margin-left: 3px; margin-bottom: 5px;">
                        <label for="chkParallaxAnim" class="rem-select" title="Animate">
                            <input type="checkbox" id="chkParallaxAnim" checked="checked" onclick="ResetCanvas()">&nbsp;Animate
                        </label>
                        <label for="chkParallaxRtl" class="rem-select" title="Right to Left">
                            <input type="checkbox" id="chkParallaxRtl" checked="checked" onclick="ResetCanvas()">&nbsp;Right to Left
                        </label>
                        <label for="chkParallaxVertical" class="rem-select" title="Right to Left">
                            <input type="checkbox" id="chkParallaxVertical" onclick="ResetCanvas()">&nbsp;Vertical
                        </label>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">Speed:</span>
                        <input type="number" class="form-control input-sm" min="-5" max="5" step=".01" id="numkParallaxSpeed" value="2" onchange="ResetCanvas()" />
                    </div>
                    <div class="input-group input-group-sm" title="Parallax Complement X">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">CX:</span>
                        <input type="number" class="form-control input-sm" min="-100" max="100" id="numParallaxX" value="0" onblur="ResetCanvas()" />
                    </div>
                    <div class="input-group input-group-sm" title="Parallax Complement Y">
                        <span class="input-group-addon addon-60p" style="font-weight: bold">CY:</span>
                        <input type="number" class="form-control input-sm" min="-100" max="100" id="numParallaxY" value="0" onblur="ResetCanvas()" />
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="content">
        <canvas id="baseCanvas" style="width: calc(100% - 2px); height: calc(100% - 2px); border:1px solid #000000;"></canvas>
    </div>
</body>
</html>